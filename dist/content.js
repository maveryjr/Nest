(()=>{console.log("Nest content script loaded");var e=null,t=null;function n(){console.log("Nest: Text selection event fired"),setTimeout(function(){var t=window.getSelection(),n=null==t?void 0:t.toString().trim();if(console.log("Nest: Selected text:",n,"Length:",null==n?void 0:n.length),n&&n.length>10){console.log("Nest: Text selection meets minimum length requirement");var r=null==t?void 0:t.getRangeAt(0);if(r){console.log("Nest: Range found, creating highlight button");var l=function(e){var t=e.commonAncestorContainer.textContent||"",n=e.startOffset,o=e.endOffset,i=Math.max(0,n-100),s=Math.min(t.length,o+100);return t.substring(i,s)}(r);e={text:n,context:l,position:o(r)},function(e){console.log("Nest: Creating highlight button"),s();var t=e.getBoundingClientRect();if(console.log("Nest: Button position:",t),0===t.width&&0===t.height){console.log("Nest: Range rect is empty, trying alternative positioning");var n=window.getSelection();if(n&&n.rangeCount>0){var o=e.startContainer,r=null;if(o.nodeType===Node.TEXT_NODE&&o.parentElement?r=o.parentElement.getBoundingClientRect():o.nodeType===Node.ELEMENT_NODE&&(r=o.getBoundingClientRect()),console.log("Nest: Alternative positioning:",r),r&&r.width>0&&r.height>0)return void i(r)}return console.log("Nest: All positioning methods failed, using viewport center fallback"),void i({bottom:window.innerHeight/2,left:window.innerWidth/2,top:window.innerHeight/2,right:window.innerWidth/2,width:0,height:0})}i(t)}(r)}}else console.log("Nest: Text selection too short or empty, hiding button"),s(),e=null},100)}function o(e){return{startOffset:e.startOffset,endOffset:e.endOffset}}function i(n){(t=document.createElement("div")).id="nest-highlight-button",t.innerHTML='\n    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n      <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>\n    </svg>\n    Save highlight\n  ';var o=window.scrollY||document.documentElement.scrollTop,i=window.scrollX||document.documentElement.scrollLeft,l=window.innerHeight,a=window.innerWidth,c=n.bottom||n.top||0,d=n.left||n.right||0;c<0&&(c=o+100),d<0&&(d=50);var g=c+10,p=Math.max(10,Math.min(a-200,d));if(console.log("Nest: Position calculation:",{rect:n,scrollTop:o,scrollLeft:i,rawTop:c,rawLeft:d,buttonTop:g,buttonLeft:p,viewportHeight:l,viewportWidth:a}),t.style.cssText="\n    position: absolute;\n    top: ".concat(g,"px;\n    left: ").concat(p,"px;\n    background: #10b981 !important;\n    color: white !important;\n    padding: 8px 12px;\n    border-radius: 6px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    z-index: 999999 !important;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n    font-size: 13px;\n    font-weight: 500;\n    cursor: pointer;\n    display: flex !important;\n    align-items: center;\n    gap: 6px;\n    animation: fadeIn 0.2s ease-out;\n    border: 1px solid #059669 !important;\n    text-decoration: none;\n    pointer-events: auto !important;\n    user-select: none;\n    min-width: 140px;\n    opacity: 1 !important;\n    visibility: visible !important;\n  "),!document.getElementById("nest-highlight-styles")){var u=document.createElement("style");u.id="nest-highlight-styles",u.textContent="\n      @keyframes fadeIn {\n        from { opacity: 0; transform: translateY(-10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      #nest-highlight-button:hover {\n        background: #059669 !important;\n        transform: translateY(-1px);\n      }\n    ",document.head.appendChild(u)}t.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),console.log("Nest: Highlight button clicked!"),console.log("Nest: saveHighlight called",e),e?(s(),console.log("Nest: Sending saveHighlight message to background script"),chrome.runtime.sendMessage({action:"saveHighlight",selectedText:e.text,context:e.context,position:e.position},function(e){console.log("Nest: Received response from background script:",e),e&&e.success?r():console.error("Failed to save highlight:",null==e?void 0:e.error)}),e=null):console.log("Nest: No selection data available")}),t.addEventListener("mousedown",function(e){e.preventDefault(),console.log("Nest: Button mousedown")}),document.body.appendChild(t),console.log("Nest: Highlight button added to page at position:",g,p),t.offsetHeight;var h=t.getBoundingClientRect(),m=h.top>=0&&h.top<=l&&h.left>=0&&h.left<=a;console.log("Nest: Button visibility check:",{buttonRect:h,isVisible:m}),m||(console.log("Nest: Button is not visible, repositioning to viewport center"),t.style.top="".concat(o+l/2,"px"),t.style.left="".concat(a/2-70,"px")),setTimeout(function(){t&&s()},8e3)}function s(){t&&t.parentNode&&(t.parentNode.removeChild(t),t=null)}function r(){var e=document.createElement("div");e.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: #8b5cf6;\n    color: white;\n    padding: 12px 24px;\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    z-index: 10000;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n    font-size: 14px;\n    font-weight: 500;\n    animation: slideIn 0.3s ease-out;\n  ",e.innerHTML="✨ Highlight saved to Nest",l(e)}function l(e){var t=document.createElement("style");t.textContent="\n    @keyframes slideIn {\n      from {\n        transform: translateX(100%);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n  ",document.head.appendChild(t),document.body.appendChild(e),setTimeout(function(){e.parentNode&&(e.style.animation="slideIn 0.3s ease-out reverse",setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},300))},3e3)}chrome.runtime.onMessage.addListener(function(e,t,n){if(console.log("Content Script: Message received:",e),"getPageContent"===e.action){var o=function(){var e=document.querySelectorAll("script, style, nav, header, footer, .ad, .advertisement"),t=document.cloneNode(!0);e.forEach(function(e){var n=t.querySelector(e.tagName.toLowerCase());n&&n.remove()});var n=t.querySelector("main")||t.querySelector("article")||t.querySelector(".content")||t.querySelector("#content")||t.querySelector(".post")||t.querySelector(".entry")||t.body;n||(n=t.body);var o=n.textContent||n.innerText||"";return(o=o.replace(/\s+/g," ").replace(/\n\s*\n/g,"\n").trim()).length>3e3&&(o=o.substring(0,3e3)+"..."),o}();console.log("Content Script: Sending page content, length:",o.length),n({content:o})}else"showSaveConfirmation"===e.action?((i=document.createElement("div")).style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: #10b981;\n    color: white;\n    padding: 12px 24px;\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    z-index: 10000;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n    font-size: 14px;\n    font-weight: 500;\n    animation: slideIn 0.3s ease-out;\n  ",i.textContent="✓ Saved to Nest",l(i)):"showHighlightConfirmation"===e.action&&r();var i;return!0}),document.addEventListener("mouseup",n),document.addEventListener("keyup",n),console.log("Nest: Text selection event listeners added"),document.addEventListener("click",function(e){t&&!t.contains(e.target)&&s()})})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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L0csSUFBb0JBLEVBQWdCZ0gsU0FBU0QsRUFBTUUsU0FDckR0RixHQUVKLEUiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9uZXN0LWNocm9tZS1leHRlbnNpb24vLi9zcmMvY29udGVudC9jb250ZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvbnRlbnQgc2NyaXB0IGZvciBleHRyYWN0aW5nIHBhZ2UgY29udGVudCBhbmQgaGFuZGxpbmcgaGlnaGxpZ2h0c1xuY29uc29sZS5sb2coJ05lc3QgY29udGVudCBzY3JpcHQgbG9hZGVkJyk7XG5cbi8vIEdsb2JhbCB2YXJpYWJsZXNcbmxldCBsYXN0U2VsZWN0aW9uOiB7IHRleHQ6IHN0cmluZzsgY29udGV4dDogc3RyaW5nOyBwb3NpdGlvbjogYW55IH0gfCBudWxsID0gbnVsbDtcbmxldCBoaWdobGlnaHRCdXR0b246IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG5cbi8vIExpc3RlbiBmb3IgbWVzc2FnZXMgZnJvbSBiYWNrZ3JvdW5kIHNjcmlwdFxuY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4ge1xuICBjb25zb2xlLmxvZygnQ29udGVudCBTY3JpcHQ6IE1lc3NhZ2UgcmVjZWl2ZWQ6JywgcmVxdWVzdCk7XG4gIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gJ2dldFBhZ2VDb250ZW50Jykge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBleHRyYWN0UGFnZUNvbnRlbnQoKTtcbiAgICBjb25zb2xlLmxvZygnQ29udGVudCBTY3JpcHQ6IFNlbmRpbmcgcGFnZSBjb250ZW50LCBsZW5ndGg6JywgY29udGVudC5sZW5ndGgpO1xuICAgIHNlbmRSZXNwb25zZSh7IGNvbnRlbnQgfSk7XG4gIH0gZWxzZSBpZiAocmVxdWVzdC5hY3Rpb24gPT09ICdzaG93U2F2ZUNvbmZpcm1hdGlvbicpIHtcbiAgICBzaG93U2F2ZUNvbmZpcm1hdGlvbigpO1xuICB9IGVsc2UgaWYgKHJlcXVlc3QuYWN0aW9uID09PSAnc2hvd0hpZ2hsaWdodENvbmZpcm1hdGlvbicpIHtcbiAgICBzaG93SGlnaGxpZ2h0Q29uZmlybWF0aW9uKCk7XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59KTtcblxuLy8gSGFuZGxlIHRleHQgc2VsZWN0aW9uIGZvciBoaWdobGlnaHRzXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlVGV4dFNlbGVjdGlvbik7XG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIGhhbmRsZVRleHRTZWxlY3Rpb24pO1xuY29uc29sZS5sb2coJ05lc3Q6IFRleHQgc2VsZWN0aW9uIGV2ZW50IGxpc3RlbmVycyBhZGRlZCcpO1xuXG5mdW5jdGlvbiBoYW5kbGVUZXh0U2VsZWN0aW9uKCkge1xuICBjb25zb2xlLmxvZygnTmVzdDogVGV4dCBzZWxlY3Rpb24gZXZlbnQgZmlyZWQnKTtcbiAgXG4gIC8vIEFkZCBhIHNtYWxsIGRlbGF5IHRvIGVuc3VyZSBzZWxlY3Rpb24gaXMgc3RhYmxlXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICBjb25zdCBzZWxlY3RlZFRleHQgPSBzZWxlY3Rpb24/LnRvU3RyaW5nKCkudHJpbSgpO1xuICAgIGNvbnNvbGUubG9nKCdOZXN0OiBTZWxlY3RlZCB0ZXh0OicsIHNlbGVjdGVkVGV4dCwgJ0xlbmd0aDonLCBzZWxlY3RlZFRleHQ/Lmxlbmd0aCk7XG4gICAgXG4gICAgaWYgKHNlbGVjdGVkVGV4dCAmJiBzZWxlY3RlZFRleHQubGVuZ3RoID4gMTApIHsgLy8gTWluaW11bSBsZW5ndGggZm9yIG1lYW5pbmdmdWwgaGlnaGxpZ2h0c1xuICAgICAgY29uc29sZS5sb2coJ05lc3Q6IFRleHQgc2VsZWN0aW9uIG1lZXRzIG1pbmltdW0gbGVuZ3RoIHJlcXVpcmVtZW50Jyk7XG4gICAgICBjb25zdCByYW5nZSA9IHNlbGVjdGlvbj8uZ2V0UmFuZ2VBdCgwKTtcbiAgICAgIGlmIChyYW5nZSkge1xuICAgICAgICBjb25zb2xlLmxvZygnTmVzdDogUmFuZ2UgZm91bmQsIGNyZWF0aW5nIGhpZ2hsaWdodCBidXR0b24nKTtcbiAgICAgICAgLy8gR2V0IGNvbnRleHQgYXJvdW5kIHRoZSBzZWxlY3Rpb25cbiAgICAgICAgY29uc3QgY29udGV4dCA9IGdldFNlbGVjdGlvbkNvbnRleHQocmFuZ2UpO1xuICAgICAgICBcbiAgICAgICAgLy8gU3RvcmUgc2VsZWN0aW9uIGRhdGFcbiAgICAgICAgbGFzdFNlbGVjdGlvbiA9IHtcbiAgICAgICAgICB0ZXh0OiBzZWxlY3RlZFRleHQsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBwb3NpdGlvbjogZ2V0U2VsZWN0aW9uUG9zaXRpb24ocmFuZ2UpXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBzaG93SGlnaGxpZ2h0QnV0dG9uKHJhbmdlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ05lc3Q6IFRleHQgc2VsZWN0aW9uIHRvbyBzaG9ydCBvciBlbXB0eSwgaGlkaW5nIGJ1dHRvbicpO1xuICAgICAgaGlkZUhpZ2hsaWdodEJ1dHRvbigpO1xuICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7XG4gICAgfVxuICB9LCAxMDApOyAvLyAxMDBtcyBkZWxheVxufVxuXG5mdW5jdGlvbiBnZXRTZWxlY3Rpb25Db250ZXh0KHJhbmdlOiBSYW5nZSk6IHN0cmluZyB7XG4gIGNvbnN0IGNvbnRhaW5lciA9IHJhbmdlLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyO1xuICBjb25zdCB0ZXh0Q29udGVudCA9IGNvbnRhaW5lci50ZXh0Q29udGVudCB8fCAnJztcbiAgY29uc3Qgc3RhcnRPZmZzZXQgPSByYW5nZS5zdGFydE9mZnNldDtcbiAgY29uc3QgZW5kT2Zmc2V0ID0gcmFuZ2UuZW5kT2Zmc2V0O1xuICBcbiAgLy8gR2V0IHN1cnJvdW5kaW5nIGNvbnRleHQgKHVwIHRvIDEwMCBjaGFyYWN0ZXJzIGJlZm9yZSBhbmQgYWZ0ZXIpXG4gIGNvbnN0IGNvbnRleHRTdGFydCA9IE1hdGgubWF4KDAsIHN0YXJ0T2Zmc2V0IC0gMTAwKTtcbiAgY29uc3QgY29udGV4dEVuZCA9IE1hdGgubWluKHRleHRDb250ZW50Lmxlbmd0aCwgZW5kT2Zmc2V0ICsgMTAwKTtcbiAgXG4gIHJldHVybiB0ZXh0Q29udGVudC5zdWJzdHJpbmcoY29udGV4dFN0YXJ0LCBjb250ZXh0RW5kKTtcbn1cblxuZnVuY3Rpb24gZ2V0U2VsZWN0aW9uUG9zaXRpb24ocmFuZ2U6IFJhbmdlKTogYW55IHtcbiAgLy8gU2ltcGxlIHBvc2l0aW9uIHRyYWNraW5nIC0gY291bGQgYmUgZW5oYW5jZWQgd2l0aCBYUGF0aCBmb3IgbW9yZSBwcmVjaXNpb25cbiAgcmV0dXJuIHtcbiAgICBzdGFydE9mZnNldDogcmFuZ2Uuc3RhcnRPZmZzZXQsXG4gICAgZW5kT2Zmc2V0OiByYW5nZS5lbmRPZmZzZXQsXG4gICAgLy8gQ291bGQgYWRkIFhQYXRoIGhlcmUgZm9yIG1vcmUgcm9idXN0IHBvc2l0aW9uaW5nXG4gIH07XG59XG5cbmZ1bmN0aW9uIHNob3dIaWdobGlnaHRCdXR0b24ocmFuZ2U6IFJhbmdlKSB7XG4gIGNvbnNvbGUubG9nKCdOZXN0OiBDcmVhdGluZyBoaWdobGlnaHQgYnV0dG9uJyk7XG4gIGhpZGVIaWdobGlnaHRCdXR0b24oKTsgLy8gUmVtb3ZlIGFueSBleGlzdGluZyBidXR0b25cbiAgXG4gIGNvbnN0IHJlY3QgPSByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgY29uc29sZS5sb2coJ05lc3Q6IEJ1dHRvbiBwb3NpdGlvbjonLCByZWN0KTtcbiAgXG4gIC8vIENoZWNrIGlmIHJlY3QgaXMgdmFsaWQgKGhhcyBkaW1lbnNpb25zKVxuICBpZiAocmVjdC53aWR0aCA9PT0gMCAmJiByZWN0LmhlaWdodCA9PT0gMCkge1xuICAgIGNvbnNvbGUubG9nKCdOZXN0OiBSYW5nZSByZWN0IGlzIGVtcHR5LCB0cnlpbmcgYWx0ZXJuYXRpdmUgcG9zaXRpb25pbmcnKTtcbiAgICBcbiAgICAvLyBUcnkgdG8gZ2V0IHBvc2l0aW9uIGZyb20gdGhlIHNlbGVjdGlvbiBpdHNlbGYgd2l0aG91dCBtb2RpZnlpbmcgRE9NXG4gICAgY29uc3Qgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICAgIGlmIChzZWxlY3Rpb24gJiYgc2VsZWN0aW9uLnJhbmdlQ291bnQgPiAwKSB7XG4gICAgICAvLyBUcnkgdG8gZ2V0IHBvc2l0aW9uIGZyb20gdGhlIHN0YXJ0IGNvbnRhaW5lclxuICAgICAgY29uc3Qgc3RhcnRDb250YWluZXIgPSByYW5nZS5zdGFydENvbnRhaW5lcjtcbiAgICAgIGxldCBhbHRlcm5hdGl2ZVJlY3Q6IERPTVJlY3QgfCBudWxsID0gbnVsbDtcbiAgICAgIFxuICAgICAgaWYgKHN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSAmJiBzdGFydENvbnRhaW5lci5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgIC8vIElmIGl0J3MgYSB0ZXh0IG5vZGUsIGdldCB0aGUgcGFyZW50IGVsZW1lbnQncyBwb3NpdGlvblxuICAgICAgICBhbHRlcm5hdGl2ZVJlY3QgPSBzdGFydENvbnRhaW5lci5wYXJlbnRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgfSBlbHNlIGlmIChzdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHtcbiAgICAgICAgLy8gSWYgaXQncyBhbiBlbGVtZW50IG5vZGUsIGdldCBpdHMgcG9zaXRpb25cbiAgICAgICAgYWx0ZXJuYXRpdmVSZWN0ID0gKHN0YXJ0Q29udGFpbmVyIGFzIEVsZW1lbnQpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zb2xlLmxvZygnTmVzdDogQWx0ZXJuYXRpdmUgcG9zaXRpb25pbmc6JywgYWx0ZXJuYXRpdmVSZWN0KTtcbiAgICAgIFxuICAgICAgaWYgKGFsdGVybmF0aXZlUmVjdCAmJiBhbHRlcm5hdGl2ZVJlY3Qud2lkdGggPiAwICYmIGFsdGVybmF0aXZlUmVjdC5oZWlnaHQgPiAwKSB7XG4gICAgICAgIGNyZWF0ZUJ1dHRvbihhbHRlcm5hdGl2ZVJlY3QpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGNvbnNvbGUubG9nKCdOZXN0OiBBbGwgcG9zaXRpb25pbmcgbWV0aG9kcyBmYWlsZWQsIHVzaW5nIHZpZXdwb3J0IGNlbnRlciBmYWxsYmFjaycpO1xuICAgIC8vIFVzZSBhIGRlZmF1bHQgcG9zaXRpb24gbmVhciB0aGUgY2VudGVyIG9mIHRoZSB2aWV3cG9ydFxuICAgIGNvbnN0IGZhbGxiYWNrUmVjdCA9IHtcbiAgICAgIGJvdHRvbTogd2luZG93LmlubmVySGVpZ2h0IC8gMixcbiAgICAgIGxlZnQ6IHdpbmRvdy5pbm5lcldpZHRoIC8gMixcbiAgICAgIHRvcDogd2luZG93LmlubmVySGVpZ2h0IC8gMixcbiAgICAgIHJpZ2h0OiB3aW5kb3cuaW5uZXJXaWR0aCAvIDIsXG4gICAgICB3aWR0aDogMCxcbiAgICAgIGhlaWdodDogMFxuICAgIH07XG4gICAgY3JlYXRlQnV0dG9uKGZhbGxiYWNrUmVjdCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICBjcmVhdGVCdXR0b24ocmVjdCk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvbihyZWN0OiBhbnkpIHtcbiAgaGlnaGxpZ2h0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIGhpZ2hsaWdodEJ1dHRvbi5pZCA9ICduZXN0LWhpZ2hsaWdodC1idXR0b24nO1xuICBoaWdobGlnaHRCdXR0b24uaW5uZXJIVE1MID0gYFxuICAgIDxzdmcgd2lkdGg9XCIxNlwiIGhlaWdodD1cIjE2XCIgdmlld0JveD1cIjAgMCAyNCAyNFwiIGZpbGw9XCJub25lXCIgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiPlxuICAgICAgPHBhdGggZD1cIk0xMiAyTDEzLjA5IDguMjZMMjAgOUwxMy4wOSA5Ljc0TDEyIDE2TDEwLjkxIDkuNzRMNCA5TDEwLjkxIDguMjZMMTIgMlpcIiBzdHJva2U9XCJjdXJyZW50Q29sb3JcIiBzdHJva2Utd2lkdGg9XCIyXCIgc3Ryb2tlLWxpbmVqb2luPVwicm91bmRcIi8+XG4gICAgPC9zdmc+XG4gICAgU2F2ZSBoaWdobGlnaHRcbiAgYDtcbiAgXG4gIC8vIENhbGN1bGF0ZSBwb3NpdGlvbiB3aXRoIGJldHRlciBoYW5kbGluZyBvZiBuZWdhdGl2ZSBjb29yZGluYXRlc1xuICBjb25zdCBzY3JvbGxUb3AgPSB3aW5kb3cuc2Nyb2xsWSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wO1xuICBjb25zdCBzY3JvbGxMZWZ0ID0gd2luZG93LnNjcm9sbFggfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQ7XG4gIFxuICAvLyBHZXQgdmlld3BvcnQgZGltZW5zaW9uc1xuICBjb25zdCB2aWV3cG9ydEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcbiAgY29uc3Qgdmlld3BvcnRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBcbiAgLy8gQ2FsY3VsYXRlIHJhdyBwb3NpdGlvblxuICBsZXQgcmF3VG9wID0gKHJlY3QuYm90dG9tIHx8IHJlY3QudG9wIHx8IDApO1xuICBsZXQgcmF3TGVmdCA9IChyZWN0LmxlZnQgfHwgcmVjdC5yaWdodCB8fCAwKTtcbiAgXG4gIC8vIEhhbmRsZSBuZWdhdGl2ZSBjb29yZGluYXRlcyBieSB1c2luZyBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbiBhcyByZWZlcmVuY2VcbiAgaWYgKHJhd1RvcCA8IDApIHtcbiAgICByYXdUb3AgPSBzY3JvbGxUb3AgKyAxMDA7IC8vIFBvc2l0aW9uIDEwMHB4IGZyb20gY3VycmVudCBzY3JvbGwgcG9zaXRpb25cbiAgfVxuICBcbiAgaWYgKHJhd0xlZnQgPCAwKSB7XG4gICAgcmF3TGVmdCA9IDUwOyAvLyBQb3NpdGlvbiA1MHB4IGZyb20gbGVmdCBlZGdlXG4gIH1cbiAgXG4gIC8vIEZpbmFsIHBvc2l0aW9uIGNhbGN1bGF0aW9uXG4gIGNvbnN0IGJ1dHRvblRvcCA9IHJhd1RvcCArIDEwOyAvLyBBZGQgc21hbGwgb2Zmc2V0IGJlbG93IHNlbGVjdGlvblxuICBjb25zdCBidXR0b25MZWZ0ID0gTWF0aC5tYXgoMTAsIE1hdGgubWluKHZpZXdwb3J0V2lkdGggLSAyMDAsIHJhd0xlZnQpKTtcbiAgXG4gIGNvbnNvbGUubG9nKCdOZXN0OiBQb3NpdGlvbiBjYWxjdWxhdGlvbjonLCB7XG4gICAgcmVjdCxcbiAgICBzY3JvbGxUb3AsXG4gICAgc2Nyb2xsTGVmdCxcbiAgICByYXdUb3AsXG4gICAgcmF3TGVmdCxcbiAgICBidXR0b25Ub3AsXG4gICAgYnV0dG9uTGVmdCxcbiAgICB2aWV3cG9ydEhlaWdodCxcbiAgICB2aWV3cG9ydFdpZHRoXG4gIH0pO1xuICBcbiAgaGlnaGxpZ2h0QnV0dG9uLnN0eWxlLmNzc1RleHQgPSBgXG4gICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgIHRvcDogJHtidXR0b25Ub3B9cHg7XG4gICAgbGVmdDogJHtidXR0b25MZWZ0fXB4O1xuICAgIGJhY2tncm91bmQ6ICMxMGI5ODEgIWltcG9ydGFudDtcbiAgICBjb2xvcjogd2hpdGUgIWltcG9ydGFudDtcbiAgICBwYWRkaW5nOiA4cHggMTJweDtcbiAgICBib3JkZXItcmFkaXVzOiA2cHg7XG4gICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsIDAsIDAsIDAuMTUpO1xuICAgIHotaW5kZXg6IDk5OTk5OSAhaW1wb3J0YW50O1xuICAgIGZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIHN5c3RlbS11aSwgc2Fucy1zZXJpZjtcbiAgICBmb250LXNpemU6IDEzcHg7XG4gICAgZm9udC13ZWlnaHQ6IDUwMDtcbiAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgZGlzcGxheTogZmxleCAhaW1wb3J0YW50O1xuICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG4gICAgZ2FwOiA2cHg7XG4gICAgYW5pbWF0aW9uOiBmYWRlSW4gMC4ycyBlYXNlLW91dDtcbiAgICBib3JkZXI6IDFweCBzb2xpZCAjMDU5NjY5ICFpbXBvcnRhbnQ7XG4gICAgdGV4dC1kZWNvcmF0aW9uOiBub25lO1xuICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvICFpbXBvcnRhbnQ7XG4gICAgdXNlci1zZWxlY3Q6IG5vbmU7XG4gICAgbWluLXdpZHRoOiAxNDBweDtcbiAgICBvcGFjaXR5OiAxICFpbXBvcnRhbnQ7XG4gICAgdmlzaWJpbGl0eTogdmlzaWJsZSAhaW1wb3J0YW50O1xuICBgO1xuICBcbiAgLy8gQWRkIGFuaW1hdGlvbiBrZXlmcmFtZXNcbiAgaWYgKCFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVzdC1oaWdobGlnaHQtc3R5bGVzJykpIHtcbiAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG4gICAgc3R5bGUuaWQgPSAnbmVzdC1oaWdobGlnaHQtc3R5bGVzJztcbiAgICBzdHlsZS50ZXh0Q29udGVudCA9IGBcbiAgICAgIEBrZXlmcmFtZXMgZmFkZUluIHtcbiAgICAgICAgZnJvbSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMTBweCk7IH1cbiAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH1cbiAgICAgIH1cbiAgICAgICNuZXN0LWhpZ2hsaWdodC1idXR0b246aG92ZXIge1xuICAgICAgICBiYWNrZ3JvdW5kOiAjMDU5NjY5ICFpbXBvcnRhbnQ7XG4gICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMXB4KTtcbiAgICAgIH1cbiAgICBgO1xuICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICB9XG4gIFxuICAvLyBBZGQgY2xpY2sgaGFuZGxlciB3aXRoIGRlYnVnIGxvZ2dpbmdcbiAgY29uc3QgY2xpY2tIYW5kbGVyID0gKGU6IEV2ZW50KSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgY29uc29sZS5sb2coJ05lc3Q6IEhpZ2hsaWdodCBidXR0b24gY2xpY2tlZCEnKTtcbiAgICBzYXZlSGlnaGxpZ2h0KCk7XG4gIH07XG4gIFxuICBoaWdobGlnaHRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjbGlja0hhbmRsZXIpO1xuICBoaWdobGlnaHRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKGUpID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc29sZS5sb2coJ05lc3Q6IEJ1dHRvbiBtb3VzZWRvd24nKTtcbiAgfSk7XG4gIFxuICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGhpZ2hsaWdodEJ1dHRvbik7XG4gIGNvbnNvbGUubG9nKCdOZXN0OiBIaWdobGlnaHQgYnV0dG9uIGFkZGVkIHRvIHBhZ2UgYXQgcG9zaXRpb246JywgYnV0dG9uVG9wLCBidXR0b25MZWZ0KTtcbiAgXG4gIC8vIEZvcmNlIGEgcmVmbG93IHRvIGVuc3VyZSB0aGUgYnV0dG9uIGlzIHJlbmRlcmVkXG4gIGhpZ2hsaWdodEJ1dHRvbi5vZmZzZXRIZWlnaHQ7XG4gIFxuICAvLyBDaGVjayBpZiBidXR0b24gaXMgYWN0dWFsbHkgdmlzaWJsZVxuICBjb25zdCBidXR0b25SZWN0ID0gaGlnaGxpZ2h0QnV0dG9uLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICBjb25zdCBpc1Zpc2libGUgPSBidXR0b25SZWN0LnRvcCA+PSAwICYmIGJ1dHRvblJlY3QudG9wIDw9IHZpZXdwb3J0SGVpZ2h0ICYmIFxuICAgICAgICAgICAgICAgICAgIGJ1dHRvblJlY3QubGVmdCA+PSAwICYmIGJ1dHRvblJlY3QubGVmdCA8PSB2aWV3cG9ydFdpZHRoO1xuICBjb25zb2xlLmxvZygnTmVzdDogQnV0dG9uIHZpc2liaWxpdHkgY2hlY2s6JywgeyBidXR0b25SZWN0LCBpc1Zpc2libGUgfSk7XG4gIFxuICBpZiAoIWlzVmlzaWJsZSkge1xuICAgIGNvbnNvbGUubG9nKCdOZXN0OiBCdXR0b24gaXMgbm90IHZpc2libGUsIHJlcG9zaXRpb25pbmcgdG8gdmlld3BvcnQgY2VudGVyJyk7XG4gICAgaGlnaGxpZ2h0QnV0dG9uLnN0eWxlLnRvcCA9IGAke3Njcm9sbFRvcCArIHZpZXdwb3J0SGVpZ2h0IC8gMn1weGA7XG4gICAgaGlnaGxpZ2h0QnV0dG9uLnN0eWxlLmxlZnQgPSBgJHt2aWV3cG9ydFdpZHRoIC8gMiAtIDcwfXB4YDtcbiAgfVxuICBcbiAgLy8gQXV0by1oaWRlIGFmdGVyIDggc2Vjb25kcyAoaW5jcmVhc2VkIGZyb20gNSlcbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaWYgKGhpZ2hsaWdodEJ1dHRvbikge1xuICAgICAgaGlkZUhpZ2hsaWdodEJ1dHRvbigpO1xuICAgIH1cbiAgfSwgODAwMCk7XG59XG5cbmZ1bmN0aW9uIGhpZGVIaWdobGlnaHRCdXR0b24oKSB7XG4gIGlmIChoaWdobGlnaHRCdXR0b24gJiYgaGlnaGxpZ2h0QnV0dG9uLnBhcmVudE5vZGUpIHtcbiAgICBoaWdobGlnaHRCdXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoaWdobGlnaHRCdXR0b24pO1xuICAgIGhpZ2hsaWdodEJ1dHRvbiA9IG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2F2ZUhpZ2hsaWdodCgpIHtcbiAgY29uc29sZS5sb2coJ05lc3Q6IHNhdmVIaWdobGlnaHQgY2FsbGVkJywgbGFzdFNlbGVjdGlvbik7XG4gIGlmICghbGFzdFNlbGVjdGlvbikge1xuICAgIGNvbnNvbGUubG9nKCdOZXN0OiBObyBzZWxlY3Rpb24gZGF0YSBhdmFpbGFibGUnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGhpZGVIaWdobGlnaHRCdXR0b24oKTtcbiAgXG4gIGNvbnNvbGUubG9nKCdOZXN0OiBTZW5kaW5nIHNhdmVIaWdobGlnaHQgbWVzc2FnZSB0byBiYWNrZ3JvdW5kIHNjcmlwdCcpO1xuICAvLyBTZW5kIG1lc3NhZ2UgdG8gYmFja2dyb3VuZCBzY3JpcHQgdG8gc2F2ZSBoaWdobGlnaHRcbiAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2Uoe1xuICAgIGFjdGlvbjogJ3NhdmVIaWdobGlnaHQnLFxuICAgIHNlbGVjdGVkVGV4dDogbGFzdFNlbGVjdGlvbi50ZXh0LFxuICAgIGNvbnRleHQ6IGxhc3RTZWxlY3Rpb24uY29udGV4dCxcbiAgICBwb3NpdGlvbjogbGFzdFNlbGVjdGlvbi5wb3NpdGlvblxuICB9LCAocmVzcG9uc2UpID0+IHtcbiAgICBjb25zb2xlLmxvZygnTmVzdDogUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSBiYWNrZ3JvdW5kIHNjcmlwdDonLCByZXNwb25zZSk7XG4gICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN1Y2Nlc3MpIHtcbiAgICAgIHNob3dIaWdobGlnaHRDb25maXJtYXRpb24oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNhdmUgaGlnaGxpZ2h0OicsIHJlc3BvbnNlPy5lcnJvcik7XG4gICAgfVxuICB9KTtcbiAgXG4gIGxhc3RTZWxlY3Rpb24gPSBudWxsO1xufVxuXG4vLyBIaWRlIGhpZ2hsaWdodCBidXR0b24gd2hlbiB1c2VyIGNsaWNrcyBlbHNld2hlcmVcbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KSA9PiB7XG4gIGlmIChoaWdobGlnaHRCdXR0b24gJiYgIWhpZ2hsaWdodEJ1dHRvbi5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSkpIHtcbiAgICBoaWRlSGlnaGxpZ2h0QnV0dG9uKCk7XG4gIH1cbn0pO1xuXG5mdW5jdGlvbiBleHRyYWN0UGFnZUNvbnRlbnQoKTogc3RyaW5nIHtcbiAgLy8gUmVtb3ZlIHNjcmlwdCBhbmQgc3R5bGUgZWxlbWVudHNcbiAgY29uc3QgZWxlbWVudHNUb1JlbW92ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3NjcmlwdCwgc3R5bGUsIG5hdiwgaGVhZGVyLCBmb290ZXIsIC5hZCwgLmFkdmVydGlzZW1lbnQnKTtcbiAgY29uc3QgY2xvbmVkRG9jID0gZG9jdW1lbnQuY2xvbmVOb2RlKHRydWUpIGFzIERvY3VtZW50O1xuICBcbiAgZWxlbWVudHNUb1JlbW92ZS5mb3JFYWNoKGVsID0+IHtcbiAgICBjb25zdCBjbG9uZWRFbCA9IGNsb25lZERvYy5xdWVyeVNlbGVjdG9yKGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSk7XG4gICAgaWYgKGNsb25lZEVsKSB7XG4gICAgICBjbG9uZWRFbC5yZW1vdmUoKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFRyeSB0byBmaW5kIG1haW4gY29udGVudCBhcmVhXG4gIGxldCBjb250ZW50RWxlbWVudCA9IFxuICAgIGNsb25lZERvYy5xdWVyeVNlbGVjdG9yKCdtYWluJykgfHxcbiAgICBjbG9uZWREb2MucXVlcnlTZWxlY3RvcignYXJ0aWNsZScpIHx8XG4gICAgY2xvbmVkRG9jLnF1ZXJ5U2VsZWN0b3IoJy5jb250ZW50JykgfHxcbiAgICBjbG9uZWREb2MucXVlcnlTZWxlY3RvcignI2NvbnRlbnQnKSB8fFxuICAgIGNsb25lZERvYy5xdWVyeVNlbGVjdG9yKCcucG9zdCcpIHx8XG4gICAgY2xvbmVkRG9jLnF1ZXJ5U2VsZWN0b3IoJy5lbnRyeScpIHx8XG4gICAgY2xvbmVkRG9jLmJvZHk7XG5cbiAgaWYgKCFjb250ZW50RWxlbWVudCkge1xuICAgIGNvbnRlbnRFbGVtZW50ID0gY2xvbmVkRG9jLmJvZHk7XG4gIH1cblxuICAvLyBFeHRyYWN0IHRleHQgY29udGVudFxuICBsZXQgdGV4dCA9IGNvbnRlbnRFbGVtZW50LnRleHRDb250ZW50IHx8IGNvbnRlbnRFbGVtZW50LmlubmVyVGV4dCB8fCAnJztcbiAgXG4gIC8vIENsZWFuIHVwIHRoZSB0ZXh0XG4gIHRleHQgPSB0ZXh0XG4gICAgLnJlcGxhY2UoL1xccysvZywgJyAnKSAvLyBSZXBsYWNlIG11bHRpcGxlIHdoaXRlc3BhY2Ugd2l0aCBzaW5nbGUgc3BhY2VcbiAgICAucmVwbGFjZSgvXFxuXFxzKlxcbi9nLCAnXFxuJykgLy8gUmVtb3ZlIGVtcHR5IGxpbmVzXG4gICAgLnRyaW0oKTtcblxuICAvLyBMaW1pdCBsZW5ndGggdG8gYXZvaWQgZXhjZXNzaXZlIGNvbnRlbnRcbiAgY29uc3QgbWF4TGVuZ3RoID0gMzAwMDtcbiAgaWYgKHRleHQubGVuZ3RoID4gbWF4TGVuZ3RoKSB7XG4gICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIG1heExlbmd0aCkgKyAnLi4uJztcbiAgfVxuXG4gIHJldHVybiB0ZXh0O1xufVxuXG4vLyBBZGQgdmlzdWFsIGZlZWRiYWNrIHdoZW4gcGFnZSBpcyBzYXZlZFxuZnVuY3Rpb24gc2hvd1NhdmVDb25maXJtYXRpb24oKSB7XG4gIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICBub3RpZmljYXRpb24uc3R5bGUuY3NzVGV4dCA9IGBcbiAgICBwb3NpdGlvbjogZml4ZWQ7XG4gICAgdG9wOiAyMHB4O1xuICAgIHJpZ2h0OiAyMHB4O1xuICAgIGJhY2tncm91bmQ6ICMxMGI5ODE7XG4gICAgY29sb3I6IHdoaXRlO1xuICAgIHBhZGRpbmc6IDEycHggMjRweDtcbiAgICBib3JkZXItcmFkaXVzOiA4cHg7XG4gICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsIDAsIDAsIDAuMTUpO1xuICAgIHotaW5kZXg6IDEwMDAwO1xuICAgIGZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIHN5c3RlbS11aSwgc2Fucy1zZXJpZjtcbiAgICBmb250LXNpemU6IDE0cHg7XG4gICAgZm9udC13ZWlnaHQ6IDUwMDtcbiAgICBhbmltYXRpb246IHNsaWRlSW4gMC4zcyBlYXNlLW91dDtcbiAgYDtcbiAgXG4gIG5vdGlmaWNhdGlvbi50ZXh0Q29udGVudCA9ICfinJMgU2F2ZWQgdG8gTmVzdCc7XG4gIFxuICBzaG93Tm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbik7XG59XG5cbi8vIEFkZCB2aXN1YWwgZmVlZGJhY2sgd2hlbiBoaWdobGlnaHQgaXMgc2F2ZWRcbmZ1bmN0aW9uIHNob3dIaWdobGlnaHRDb25maXJtYXRpb24oKSB7XG4gIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICBub3RpZmljYXRpb24uc3R5bGUuY3NzVGV4dCA9IGBcbiAgICBwb3NpdGlvbjogZml4ZWQ7XG4gICAgdG9wOiAyMHB4O1xuICAgIHJpZ2h0OiAyMHB4O1xuICAgIGJhY2tncm91bmQ6ICM4YjVjZjY7XG4gICAgY29sb3I6IHdoaXRlO1xuICAgIHBhZGRpbmc6IDEycHggMjRweDtcbiAgICBib3JkZXItcmFkaXVzOiA4cHg7XG4gICAgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsIDAsIDAsIDAuMTUpO1xuICAgIHotaW5kZXg6IDEwMDAwO1xuICAgIGZvbnQtZmFtaWx5OiAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIHN5c3RlbS11aSwgc2Fucy1zZXJpZjtcbiAgICBmb250LXNpemU6IDE0cHg7XG4gICAgZm9udC13ZWlnaHQ6IDUwMDtcbiAgICBhbmltYXRpb246IHNsaWRlSW4gMC4zcyBlYXNlLW91dDtcbiAgYDtcbiAgXG4gIG5vdGlmaWNhdGlvbi5pbm5lckhUTUwgPSAn4pyoIEhpZ2hsaWdodCBzYXZlZCB0byBOZXN0JztcbiAgXG4gIHNob3dOb3RpZmljYXRpb24obm90aWZpY2F0aW9uKTtcbn1cblxuZnVuY3Rpb24gc2hvd05vdGlmaWNhdGlvbihub3RpZmljYXRpb246IEhUTUxFbGVtZW50KSB7XG4gIC8vIEFkZCBhbmltYXRpb24ga2V5ZnJhbWVzXG4gIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgc3R5bGUudGV4dENvbnRlbnQgPSBgXG4gICAgQGtleWZyYW1lcyBzbGlkZUluIHtcbiAgICAgIGZyb20ge1xuICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMTAwJSk7XG4gICAgICAgIG9wYWNpdHk6IDA7XG4gICAgICB9XG4gICAgICB0byB7XG4gICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgwKTtcbiAgICAgICAgb3BhY2l0eTogMTtcbiAgICAgIH1cbiAgICB9XG4gIGA7XG4gIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICBcbiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChub3RpZmljYXRpb24pO1xuICBcbiAgLy8gUmVtb3ZlIGFmdGVyIDMgc2Vjb25kc1xuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICBpZiAobm90aWZpY2F0aW9uLnBhcmVudE5vZGUpIHtcbiAgICAgIG5vdGlmaWNhdGlvbi5zdHlsZS5hbmltYXRpb24gPSAnc2xpZGVJbiAwLjNzIGVhc2Utb3V0IHJldmVyc2UnO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChub3RpZmljYXRpb24ucGFyZW50Tm9kZSkge1xuICAgICAgICAgIG5vdGlmaWNhdGlvbi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vdGlmaWNhdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH0sIDMwMCk7XG4gICAgfVxuICB9LCAzMDAwKTtcbn0gIl0sIm5hbWVzIjpbImNvbnNvbGUiLCJsb2ciLCJsYXN0U2VsZWN0aW9uIiwiaGlnaGxpZ2h0QnV0dG9uIiwiaGFuZGxlVGV4dFNlbGVjdGlvbiIsInNldFRpbWVvdXQiLCJzZWxlY3Rpb24iLCJ3aW5kb3ciLCJnZXRTZWxlY3Rpb24iLCJzZWxlY3RlZFRleHQiLCJ0b1N0cmluZyIsInRyaW0iLCJsZW5ndGgiLCJyYW5nZSIsImdldFJhbmdlQXQiLCJjb250ZXh0IiwidGV4dENvbnRlbnQiLCJjb21tb25BbmNlc3RvckNvbnRhaW5lciIsInN0YXJ0T2Zmc2V0IiwiZW5kT2Zmc2V0IiwiY29udGV4dFN0YXJ0IiwiTWF0aCIsIm1heCIsImNvbnRleHRFbmQiLCJtaW4iLCJzdWJzdHJpbmciLCJnZXRTZWxlY3Rpb25Db250ZXh0IiwidGV4dCIsInBvc2l0aW9uIiwiZ2V0U2VsZWN0aW9uUG9zaXRpb24iLCJoaWRlSGlnaGxpZ2h0QnV0dG9uIiwicmVjdCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsIndpZHRoIiwiaGVpZ2h0IiwicmFuZ2VDb3VudCIsInN0YXJ0Q29udGFpbmVyIiwiYWx0ZXJuYXRpdmVSZWN0Iiwibm9kZVR5cGUiLCJOb2RlIiwiVEVYVF9OT0RFIiwicGFyZW50RWxlbWVudCIsIkVMRU1FTlRfTk9ERSIsImNyZWF0ZUJ1dHRvbiIsImJvdHRvbSIsImlubmVySGVpZ2h0IiwibGVmdCIsImlubmVyV2lkdGgiLCJ0b3AiLCJyaWdodCIsInNob3dIaWdobGlnaHRCdXR0b24iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJpZCIsImlubmVySFRNTCIsInNjcm9sbFRvcCIsInNjcm9sbFkiLCJkb2N1bWVudEVsZW1lbnQiLCJzY3JvbGxMZWZ0Iiwic2Nyb2xsWCIsInZpZXdwb3J0SGVpZ2h0Iiwidmlld3BvcnRXaWR0aCIsInJhd1RvcCIsInJhd0xlZnQiLCJidXR0b25Ub3AiLCJidXR0b25MZWZ0Iiwic3R5bGUiLCJjc3NUZXh0IiwiY29uY2F0IiwiZ2V0RWxlbWVudEJ5SWQiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJhZGRFdmVudExpc3RlbmVyIiwiZSIsInByZXZlbnREZWZhdWx0Iiwic3RvcFByb3BhZ2F0aW9uIiwiY2hyb21lIiwicnVudGltZSIsInNlbmRNZXNzYWdlIiwiYWN0aW9uIiwicmVzcG9uc2UiLCJzdWNjZXNzIiwic2hvd0hpZ2hsaWdodENvbmZpcm1hdGlvbiIsImVycm9yIiwiYm9keSIsIm9mZnNldEhlaWdodCIsImJ1dHRvblJlY3QiLCJpc1Zpc2libGUiLCJwYXJlbnROb2RlIiwicmVtb3ZlQ2hpbGQiLCJub3RpZmljYXRpb24iLCJzaG93Tm90aWZpY2F0aW9uIiwiYW5pbWF0aW9uIiwib25NZXNzYWdlIiwiYWRkTGlzdGVuZXIiLCJyZXF1ZXN0Iiwic2VuZGVyIiwic2VuZFJlc3BvbnNlIiwiY29udGVudCIsImVsZW1lbnRzVG9SZW1vdmUiLCJxdWVyeVNlbGVjdG9yQWxsIiwiY2xvbmVkRG9jIiwiY2xvbmVOb2RlIiwiZm9yRWFjaCIsImVsIiwiY2xvbmVkRWwiLCJxdWVyeVNlbGVjdG9yIiwidGFnTmFtZSIsInRvTG93ZXJDYXNlIiwicmVtb3ZlIiwiY29udGVudEVsZW1lbnQiLCJpbm5lclRleHQiLCJyZXBsYWNlIiwiZXh0cmFjdFBhZ2VDb250ZW50IiwiZXZlbnQiLCJjb250YWlucyIsInRhcmdldCJdLCJzb3VyY2VSb290IjoiIn0=